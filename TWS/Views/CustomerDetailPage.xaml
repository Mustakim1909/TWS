<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="TWS.Views.CustomerDetailPage"
             Title="Orders"
             BackgroundColor="{StaticResource PageBackgroundColor}">

    <ContentPage.Resources>
        <ResourceDictionary>
            <!-- Colors -->
            <Color x:Key="PrimaryColor">#4A6FA5</Color>
            <Color x:Key="SecondaryColor">#166D67</Color>
            <Color x:Key="AccentColor">#F4B400</Color>
            <Color x:Key="PageBackgroundColor">#F5F7FA</Color>
            <Color x:Key="CardBackgroundColor">#FFFFFF</Color>
            <Color x:Key="TextColor">#333333</Color>
            <Color x:Key="SubTextColor">#666666</Color>
            <Color x:Key="BorderColor">#E1E5E9</Color>

            <!-- Default Label -->
            <Style TargetType="Label">
                <Setter Property="TextColor" Value="{DynamicResource TextColor}" />
                <Setter Property="FontFamily" Value="OpenSans-Regular" />
            </Style>

            <!-- Page Header -->
            <Style x:Key="HeaderLabel" TargetType="Label">
                <Setter Property="FontSize" Value="26" />
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="HorizontalOptions" Value="Center" />
                <Setter Property="Margin" Value="0,25,0,20" />
                <Setter Property="TextColor" Value="{DynamicResource PrimaryColor}" />
            </Style>

            <!-- Search Entry -->
            <Style x:Key="SearchEntry" TargetType="Entry">
                <Setter Property="Placeholder" Value="🔍 Search orders..." />
                <Setter Property="PlaceholderColor" Value="#999" />
                <Setter Property="BackgroundColor" Value="White" />
                <Setter Property="HeightRequest" Value="48" />
                <Setter Property="Margin" Value="20,10,10,10" />
                <Setter Property="FontSize" Value="16" />
                <Setter Property="ClearButtonVisibility" Value="WhileEditing" />
                <Setter Property="VerticalOptions" Value="Center" />
            </Style>

            <!-- Search Button -->
            <Style x:Key="SearchButton" TargetType="Button">
                <Setter Property="BackgroundColor" Value="{DynamicResource PrimaryColor}" />
                <Setter Property="TextColor" Value="White" />
                <Setter Property="CornerRadius" Value="12" />
                <Setter Property="HeightRequest" Value="48" />
                <Setter Property="Padding" Value="20,0" />
                <Setter Property="FontSize" Value="16" />
                <Setter Property="Shadow">
                    <Setter.Value>
                        <Shadow Brush="Black" Opacity="0.2" Radius="8" />
                    </Setter.Value>
                </Setter>
            </Style>

            <!-- Customer Card -->
            <Style x:Key="CustomerItem" TargetType="Frame">
                <Setter Property="BackgroundColor" Value="{DynamicResource CardBackgroundColor}" />
                <Setter Property="CornerRadius" Value="14" />
                <Setter Property="HasShadow" Value="True" />
                <Setter Property="Padding" Value="15" />
                <Setter Property="Margin" Value="20,0,20,15" />
                <Setter Property="BorderColor" Value="{DynamicResource BorderColor}" />
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,Auto,*">

        <!-- Search Bar -->
        <Grid ColumnDefinitions="*,Auto"
              Grid.Row="1"
              Margin="0,0,0,15">
            <Entry x:Name="SearchEntry"
                   Style="{StaticResource SearchEntry}"
                   Text="{Binding SearchText}" />
            <Button Text="Search"
                    Grid.Column="1"
                    Margin="0,10,20,10"
                    Style="{StaticResource SearchButton}"
                    Command="{Binding SearchCommand}"
                    CommandParameter="{Binding Source={x:Reference SearchEntry}, Path=Text}" />
        </Grid>

        <!-- Customer List -->
        <RefreshView Grid.Row="2"
                     IsRefreshing="{Binding IsRefreshing}"
                     Command="{Binding RefreshCommand}">
            <CollectionView ItemsSource="{Binding Customers}"
                            SelectionMode="None">
                <CollectionView.EmptyView>
                    <StackLayout VerticalOptions="Center"
                                 HorizontalOptions="Center"
                                 Padding="40">
                        <Label Text="No orders found"
                               FontSize="16"
                               FontAttributes="Bold"
                               TextColor="{StaticResource TextColor}" />
                        <Label Text="Pull down to refresh or check your connection"
                               FontSize="14"
                               TextColor="{StaticResource SubTextColor}"
                               Margin="0,10,0,0" />
                    </StackLayout>
                </CollectionView.EmptyView>

                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Frame Style="{StaticResource CustomerItem}">
                            <Grid ColumnDefinitions="Auto,*,Auto,Auto"
                  RowDefinitions="Auto,Auto"
                  ColumnSpacing="12">

                                <!-- Avatar -->
                                <Frame Grid.RowSpan="2"
                       CornerRadius="25"
                       HeightRequest="50"
                       WidthRequest="50"
                       Padding="0"
                       VerticalOptions="Center"
                       HasShadow="False">
                                    <Image Source="user.png"
                           Aspect="AspectFill"
                           HorizontalOptions="Fill"
                           VerticalOptions="Fill" />
                                </Frame>

                                <!-- Name -->
                                <Label Grid.Column="1"
                       Grid.Row="0"
                       Text="{Binding Billing.FullName}"
                       FontSize="16"
                       FontAttributes="Bold"
                       VerticalOptions="End" />

                                <!-- Phone -->
                                <Label Grid.Column="1"
                       Grid.Row="1"
                       Text="{Binding Billing.Phone}"
                       FontSize="14"
                       TextColor="{StaticResource SubTextColor}"
                       VerticalOptions="Start" />

                                <!-- View Icon -->
                                <ImageButton Grid.Column="2"
                             Grid.Row="0"
                             Grid.RowSpan="2"
                             Source="view.png"
                             BackgroundColor="Transparent"
                             HeightRequest="28"
                             WidthRequest="28"
                             Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.ViewInvoiceCommand}"  
                             CommandParameter="{Binding .}" />

                                <!-- Edit Icon -->
                                <ImageButton Grid.Column="3"
                             Grid.Row="0"
                             Grid.RowSpan="2"
                             Source="edit.png"
                             BackgroundColor="Transparent"
                             HeightRequest="28"
                             WidthRequest="28"
                             Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.EditInvoiceCommand}"
                             CommandParameter="{Binding .}" />

                                <!-- Tap Gesture (whole card click) -->
                                <Grid.GestureRecognizers>
                                    <TapGestureRecognizer 
                        Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.CustomerSelectedCommand}"
                        CommandParameter="{Binding .}" />
                                </Grid.GestureRecognizers>
                            </Grid>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>

            </CollectionView>
        </RefreshView>
        <!-- Loading Indicator -->
        <ActivityIndicator Grid.RowSpan="3"
                           HorizontalOptions="Center"
                           VerticalOptions="Center"
                           Color="{StaticResource PrimaryColor}"
                           IsRunning="{Binding IsLoading}"
                           IsVisible="{Binding IsLoading}" />

        <!-- Add Customer Floating Button -->
        <Button Text="+"
                WidthRequest="60"
                HeightRequest="60"
                CornerRadius="30"
                BackgroundColor="{DynamicResource PrimaryColor}"
                TextColor="White"
                FontSize="28"
                Grid.RowSpan="3"
                HorizontalOptions="End"
                VerticalOptions="End"
                Margin="20,20,20,30"
                Command="{Binding AddCustomerCommand}" />
    </Grid>
</ContentPage>
